@model Bulky.Models.ViewModels.ProductVM

@{
    ViewData["Title"] = "Edit Product";
}

<div class="container-fluid px-2 px-sm-3 py-2 py-md-4">
    <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-8 col-lg-7 col-xl-6">
            <div class="card shadow-lg border-0">
                <!-- Card Header -->
                <div class="card-header bg-success bg-gradient text-white py-3 py-md-4">
                    <div class="text-center">
                        <h1 class="fs-4 fs-md-3 fw-normal mb-1">
                            <i class="bi bi-pencil-square me-2"></i>Edit Product
                        </h1>
                        <p class="mb-0 opacity-75 small d-none d-md-block">Update product information</p>
                        <p class="mb-0 opacity-75 small d-md-none">Update product</p>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="card-body p-3 p-sm-4 p-md-5">
                    <form asp-action="Edit" class="needs-validation" novalidate enctype="multipart/form-data">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger small mb-3 d-none" role="alert"></div>
                        
                        <!-- Hidden ID Field -->
                        <input type="hidden" asp-for="Product.Id" />

                        <!-- Current Product Info -->
                        <div class="alert alert-success border-0 py-2 px-3 mb-3 mb-md-4 d-flex align-items-center" style="background-color: rgba(75, 113, 71, 0.1); border-left: 4px solid #4b7147 !important;">
                            <i class="bi bi-info-circle me-2 text-success"></i>
                            <small class="text-success">
                                <strong>Editing:</strong> Product ID @Model.Product.Id
                                <span class="d-none d-sm-inline">- @Model.Product.Title</span>
                            </small>
                        </div>

                        <!-- Image Display Section -->
                        <div class="mb-4">
                            <h6 class="text-info fw-bold mb-3">
                                <i class="bi bi-image me-2"></i>Product Image
                            </h6>

                            <!-- Current Image Display - Enhanced -->
                            @if (!string.IsNullOrEmpty(Model.Product.ImageUrl))
                            {
                                <div class="mb-4">
                                    <div class="text-center">
                                        <div class="position-relative d-inline-block">
                                            <img id="currentImage" 
                                                 src="@Model.Product.ImageUrl" 
                                                 alt="Current Product Image - @Model.Product.Title" 
                                                 class="img-fluid border border-info shadow rounded"
                                                 style="max-width: 300px; max-height: 300px; border-width: 3px !important; object-fit: cover;" />
                                            <div class="position-absolute top-0 start-0">
                                                <span class="badge bg-info bg-opacity-90 text-white py-2 px-3 m-2">
                                                    <i class="bi bi-check-circle me-1"></i>Current Image
                                                </span>
                                            </div>
                                            <div class="position-absolute bottom-0 end-0">
                                                <button type="button" 
                                                        id="changeImageBtn" 
                                                        class="btn btn-outline-info btn-sm m-2"
                                                        title="Change Image">
                                                    <i class="bi bi-camera me-1"></i>Change
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-center mt-3">
                                        <div class="d-flex justify-content-center align-items-center gap-3">
                                            <small class="text-info fw-medium">
                                                <i class="bi bi-info-circle me-1"></i>
                                                <strong>Current image will be replaced if you upload a new one</strong>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- No Image State -->
                                <div class="mb-4">
                                    <div class="text-center">
                                        <div class="border border-info border-3 rounded d-flex align-items-center justify-content-center bg-light p-4"
                                             style="height: 200px; border-style: dashed !important;">
                                            <div class="text-center text-info">
                                                <i class="bi bi-image display-4 mb-3 opacity-50"></i>
                                                <h6 class="fw-medium mb-2">No Image Available</h6>
                                                <p class="small text-muted mb-0">Upload an image to showcase this product</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Image Upload Controls -->
                            <div id="imageUploadSection" class="@(string.IsNullOrEmpty(Model.Product.ImageUrl) ? "" : "d-none")">
                                <!-- Image Preview Area -->
                                <div class="mb-3">
                                    <div class="text-center">
                                        <div id="imagePreviewContainer" class="position-relative d-inline-block">
                                            <img id="imagePreview" 
                                                 src="#" 
                                                 alt="New Product Image Preview" 
                                                 class="img-fluid border border-info shadow rounded d-none"
                                                 style="max-width: 300px; max-height: 300px; border-width: 3px !important; object-fit: cover;" />
                                            <div id="imagePreviewPlaceholder" 
                                                 class="border border-info border-3 rounded d-flex align-items-center justify-content-center bg-light"
                                                 style="width: 300px; height: 200px; border-style: dashed !important;">
                                                <div class="text-center text-info">
                                                    <i class="bi bi-cloud-upload display-4 mb-2"></i>
                                                    <p class="small mb-0 fw-medium">New Image Preview</p>
                                                    <p class="small text-muted mb-0">Drag & drop or click to upload</p>
                                                </div>
                                            </div>
                                            <button type="button" 
                                                    id="removeImageBtn" 
                                                    class="btn btn-danger btn-sm position-absolute top-0 end-0 rounded-circle d-none"
                                                    style="width: 35px; height: 35px; margin-top: -5px; margin-right: -5px;">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- File Input Field -->
                                <div class="mb-3">
                                    <div class="input-group input-group-lg">
                                        <input type="file" 
                                               id="imageFile" 
                                               name="imageFile" 
                                               class="form-control border-info" 
                                               accept="image/*"
                                               style="border-width: 2px;" />
                                        <button type="button" 
                                                id="uploadImageBtn" 
                                                class="btn btn-outline-info fw-medium px-4">
                                            <i class="bi bi-cloud-upload me-2"></i>Browse Files
                                        </button>
                                    </div>
                                    <div class="form-text small text-info mt-2">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span id="imageHelpText">Select a new product image (JPG, PNG, GIF - Max 5MB)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Image Actions for Existing Image -->
                            @if (!string.IsNullOrEmpty(Model.Product.ImageUrl))
                            {
                                <div class="text-center">
                                    <div class="btn-group" role="group">
                                        <button type="button" 
                                                id="showUploadBtn" 
                                                class="btn btn-outline-info">
                                            <i class="bi bi-upload me-1"></i>Upload New Image
                                        </button>
                                        <button type="button" 
                                                id="removeCurrentImageBtn" 
                                                class="btn btn-outline-danger">
                                            <i class="bi bi-trash me-1"></i>Remove Current Image
                                        </button>
                                    </div>
                                </div>
                            }

                            <!-- Hidden field for ImageUrl -->
                            <input asp-for="Product.ImageUrl" type="hidden" />
                        </div>
                        
                        <!-- Product Information Section -->
                        <div class="mb-4">
                            <h6 class="text-success fw-bold mb-3">
                                <i class="bi bi-info-circle me-2"></i>Product Information
                            </h6>
                            
                            <!-- Title Field -->
                            <div class="mb-3 mb-md-4">
                                <div class="form-floating">
                                    <input asp-for="Product.Title" 
                                           class="form-control form-control-lg border-success" 
                                           placeholder="Enter Product Title"
                                           maxlength="100"
                                           required 
                                           style="border-width: 2px;" />
                                    <label asp-for="Product.Title" class="text-success fw-medium">
                                        <i class="bi bi-book me-1"></i>Product Title
                                    </label>
                                </div>
                                <span asp-validation-for="Product.Title" class="text-danger small mt-1 d-block"></span>
                                <div class="form-text small text-success">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <span id="titleHelpText">Update the product title (max 100 characters)</span>
                                </div>
                            </div>

                            <!-- Author Field -->
                            <div class="mb-3 mb-md-4">
                                <div class="form-floating">
                                    <input asp-for="Product.Author" 
                                           class="form-control form-control-lg border-success" 
                                           placeholder="Enter Author Name"
                                           maxlength="50"
                                           required 
                                           style="border-width: 2px;" />
                                    <label asp-for="Product.Author" class="text-success fw-medium">
                                        <i class="bi bi-person me-1"></i>Author Name
                                    </label>
                                </div>
                                <span asp-validation-for="Product.Author" class="text-danger small mt-1 d-block"></span>
                                <div class="form-text small text-success">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Update the author's full name
                                </div>
                            </div>

                            <!-- ISBN Field -->
                            <div class="mb-3 mb-md-4">
                                <div class="form-floating">
                                    <input asp-for="Product.ISBN" 
                                           class="form-control form-control-lg border-success" 
                                           placeholder="Enter ISBN"
                                           pattern="[0-9A-Za-z\-]+"
                                           required 
                                           style="border-width: 2px;" />
                                    <label asp-for="Product.ISBN" class="text-success fw-medium">
                                        <i class="bi bi-upc me-1"></i>ISBN Number
                                    </label>
                                </div>
                                <span asp-validation-for="Product.ISBN" class="text-danger small mt-1 d-block"></span>
                                <div class="form-text small text-success">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Update the unique ISBN identifier
                                </div>
                            </div>

                            <!-- Category Selection Field -->
                            <div class="mb-3 mb-md-4">
                                <div class="form-floating">
                                    <select asp-for="Product.CategoryId" 
                                            asp-items="@Model.CategoryList"
                                            class="form-select form-select-lg border-success" 
                                            required 
                                            style="border-width: 2px;">
                                        <option value="">-- Select Category --</option>
                                    </select>
                                    <label asp-for="Product.CategoryId" class="text-success fw-medium">
                                        <i class="bi bi-collection me-1"></i>Product Category
                                    </label>
                                </div>
                                <span asp-validation-for="Product.CategoryId" class="text-danger small mt-1 d-block"></span>
                                <div class="form-text small text-success">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <span id="categoryHelpText">Update the category this product belongs to</span>
                                </div>
                            </div>

                            <!-- Description Field -->
                            <div class="mb-4 mb-md-5">
                                <div class="form-floating">
                                    <textarea asp-for="Product.Description" 
                                              class="form-control border-success" 
                                              placeholder="Enter Product Description"
                                              rows="4"
                                              maxlength="500"
                                              style="border-width: 2px; min-height: 120px;"></textarea>
                                    <label asp-for="Product.Description" class="text-success fw-medium">
                                        <i class="bi bi-file-text me-1"></i>Product Description
                                    </label>
                                </div>
                                <span asp-validation-for="Product.Description" class="text-danger small mt-1 d-block"></span>
                                <div class="form-text small text-success">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <span id="descriptionHelpText">Update the product description (max 500 characters)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Section -->
                        <div class="mb-4">
                            <h6 class="text-warning fw-bold mb-3">
                                <i class="bi bi-currency-dollar me-2"></i>Pricing Information
                            </h6>
                            
                            <div class="row g-3">
                                <!-- List Price -->
                                <div class="col-12 col-md-6">
                                    <div class="form-floating">
                                        <input asp-for="Product.ListPrice" 
                                               class="form-control border-warning" 
                                               placeholder="List Price"
                                               type="number"
                                               step="0.01"
                                               min="0.01"
                                               max="10000"
                                               required 
                                               style="border-width: 2px;" />
                                        <label asp-for="Product.ListPrice" class="text-warning fw-medium">
                                            <i class="bi bi-tag me-1"></i>List Price
                                        </label>
                                    </div>
                                    <span asp-validation-for="Product.ListPrice" class="text-danger small mt-1 d-block"></span>
                                </div>

                                <!-- Regular Price -->
                                <div class="col-12 col-md-6">
                                    <div class="form-floating">
                                        <input asp-for="Product.Price" 
                                               class="form-control border-warning" 
                                               placeholder="Regular Price"
                                               type="number"
                                               step="0.01"
                                               min="0.01"
                                               max="10000"
                                               required 
                                               style="border-width: 2px;" />
                                        <label asp-for="Product.Price" class="text-warning fw-medium">
                                            <i class="bi bi-currency-dollar me-1"></i>Price (1-50)
                                        </label>
                                    </div>
                                    <span asp-validation-for="Product.Price" class="text-danger small mt-1 d-block"></span>
                                </div>

                                <!-- Bulk Price 50+ -->
                                <div class="col-12 col-md-6">
                                    <div class="form-floating">
                                        <input asp-for="Product.Price50" 
                                               class="form-control border-warning" 
                                               placeholder="Price for 50+"
                                               type="number"
                                               step="0.01"
                                               min="0.01"
                                               max="10000"
                                               required 
                                               style="border-width: 2px;" />
                                        <label asp-for="Product.Price50" class="text-warning fw-medium">
                                            <i class="bi bi-cart me-1"></i>Price (50-100)
                                        </label>
                                    </div>
                                    <span asp-validation-for="Product.Price50" class="text-danger small mt-1 d-block"></span>
                                </div>

                                <!-- Bulk Price 100+ -->
                                <div class="col-12 col-md-6">
                                    <div class="form-floating">
                                        <input asp-for="Product.Price100" 
                                               class="form-control border-warning" 
                                               placeholder="Price for 100+"
                                               type="number"
                                               step="0.01"
                                               min="0.01"
                                               max="10000"
                                               required 
                                               style="border-width: 2px;" />
                                        <label asp-for="Product.Price100" class="text-warning fw-medium">
                                            <i class="bi bi-cart-plus me-1"></i>Price (100+)
                                        </label>
                                    </div>
                                    <span asp-validation-for="Product.Price100" class="text-danger small mt-1 d-block"></span>
                                </div>
                            </div>

                            <div class="form-text small text-warning mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                Update tiered pricing for bulk purchases. Higher quantities should have lower prices.
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row g-2 g-md-3 mt-3">
                            <div class="col-12 col-sm-6">
                                <button type="submit" class="btn btn-success w-100 py-2 py-md-3 shadow-sm fw-medium">
                                    <i class="bi bi-check-circle me-2"></i>
                                    <span class="d-none d-sm-inline">Update Product</span>
                                    <span class="d-sm-none">Update</span>
                                </button>
                            </div>
                            <div class="col-12 col-sm-6">
                                <a asp-action="Index" class="btn btn-secondary w-100 py-2 py-md-3 shadow-sm fw-medium">
                                    <i class="bi bi-arrow-left me-2"></i>
                                    <span class="d-none d-sm-inline">Back to List</span>
                                    <span class="d-sm-none">Back</span>
                                </a>
                            </div>
                        </div>

                        <!-- Additional Actions (Desktop Only) -->
                        <div class="d-none d-md-flex justify-content-between align-items-center mt-4 pt-3 border-top border-success" style="border-width: 2px !important;">
                            <small class="text-muted d-flex align-items-center">
                                <i class="bi bi-clock me-1 text-success"></i>
                                Last modified: <span class="ms-1 text-success fw-medium">@DateTime.Now.ToString("MMM dd, yyyy")</span>
                            </small>
                            <a asp-action="Delete" asp-route-id="@Model.Product.Id" 
                               class="btn btn-outline-danger btn-sm shadow-sm">
                                <i class="bi bi-trash me-1"></i>Delete
                            </a>
                        </div>

                        <!-- Progress Indicator -->
                        <div class="text-center mt-3 d-none" id="loadingIndicator">
                            <div class="spinner-border spinner-border-sm text-success me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <small class="text-success fw-medium">Updating product...</small>
                        </div>
                    </form>
                </div>

                <!-- Card Footer with Tips -->
                <div class="card-footer text-center py-3 py-md-3 d-none d-md-block" 
                     style="background: linear-gradient(135deg, rgba(75, 113, 71, 0.05) 0%, rgba(87, 133, 83, 0.05) 100%); border-top: 2px solid rgba(75, 113, 71, 0.1);">
                    <small class="text-success">
                        <i class="bi bi-lightbulb me-1 text-warning"></i>
                        <strong>Tip:</strong> Changes will be reflected immediately in the product catalog
                    </small>
                </div>
            </div>

            <!-- Mobile Actions Card -->
            <div class="d-md-none mt-3">
                <div class="card shadow-sm border-0">
                    <div class="card-body py-3 px-3" style="background: linear-gradient(135deg, rgba(202, 25, 41, 0.05) 0%, rgba(202, 25, 41, 0.1) 100%); border-left: 4px solid #CA1929;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle me-2 text-danger"></i>
                                <small class="text-danger fw-medium">
                                    Need to delete this product?
                                </small>
                            </div>
                            <a asp-action="Delete" asp-route-id="@Model.Product.Id" 
                               class="btn btn-outline-danger btn-sm shadow-sm">
                                <i class="bi bi-trash me-1"></i>Delete
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Help Card -->
            <div class="card mt-3 d-md-none shadow-sm border-0">
                <div class="card-body py-3 px-3" 
                     style="background: linear-gradient(135deg, rgba(75, 113, 71, 0.05) 0%, rgba(75, 113, 71, 0.1) 100%); border-left: 4px solid #4b7147;">
                    <small class="d-flex align-items-center text-success">
                        <i class="bi bi-lightbulb me-2"></i>
                        <span class="fw-medium">Changes are reflected immediately in catalog</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced form validation with theme colors
            const forms = document.querySelectorAll('.needs-validation');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            Array.prototype.slice.call(forms).forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        // Show validation summary if there are errors
                        const validationSummary = form.querySelector('[asp-validation-summary]');
                        if (validationSummary) {
                            validationSummary.classList.remove('d-none');
                        }
                        
                        // Add error styling to invalid fields
                        const invalidFields = form.querySelectorAll(':invalid');
                        invalidFields.forEach(field => {
                            field.style.borderColor = '#CA1929';
                            field.style.borderWidth = '2px';
                        });
                    } else {
                        // Show loading indicator on valid submission
                        if (loadingIndicator) {
                            loadingIndicator.classList.remove('d-none');
                        }
                        
                        // Disable submit button to prevent double submission
                        const submitBtn = form.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Updating...';
                        }
                    }
                    
                    form.classList.add('was-validated');
                }, false);
            });

            // Enhanced Image Management
            const imageFile = document.getElementById('imageFile');
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewPlaceholder = document.getElementById('imagePreviewPlaceholder');
            const removeImageBtn = document.getElementById('removeImageBtn');
            const uploadImageBtn = document.getElementById('uploadImageBtn');
            const imageHelpText = document.getElementById('imageHelpText');
            const imageUrlInput = document.querySelector('input[name="Product.ImageUrl"]');
            const currentImage = document.getElementById('currentImage');
            const imageUploadSection = document.getElementById('imageUploadSection');
            const showUploadBtn = document.getElementById('showUploadBtn');
            const removeCurrentImageBtn = document.getElementById('removeCurrentImageBtn');
            const changeImageBtn = document.getElementById('changeImageBtn');

            // Show upload section when "Upload New Image" is clicked
            if (showUploadBtn) {
                showUploadBtn.addEventListener('click', function() {
                    imageUploadSection.classList.remove('d-none');
                    this.classList.add('d-none');
                    if (removeCurrentImageBtn) {
                        removeCurrentImageBtn.classList.add('d-none');
                    }
                });
            }

            // Change image button functionality
            if (changeImageBtn) {
                changeImageBtn.addEventListener('click', function() {
                    imageUploadSection.classList.remove('d-none');
                    if (showUploadBtn) {
                        showUploadBtn.classList.add('d-none');
                    }
                    if (removeCurrentImageBtn) {
                        removeCurrentImageBtn.classList.add('d-none');
                    }
                });
            }

            // Remove current image functionality
            if (removeCurrentImageBtn) {
                removeCurrentImageBtn.addEventListener('click', function() {
                    if (confirm('⚠️ Are you sure you want to remove the current image?\n\nThis action will remove the image when you save the product.')) {
                        if (currentImage) {
                            currentImage.style.opacity = '0.3';
                            currentImage.style.filter = 'grayscale(100%)';
                        }
                        
                        // Clear the hidden field to indicate image removal
                        if (imageUrlInput) {
                            imageUrlInput.value = '';
                        }
                        
                        // Show upload section
                        imageUploadSection.classList.remove('d-none');
                        
                        // Hide action buttons
                        if (showUploadBtn) {
                            showUploadBtn.classList.add('d-none');
                        }
                        this.classList.add('d-none');
                        
                        // Update help text
                        if (imageHelpText) {
                            imageHelpText.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Current image will be removed - upload a new one or cancel to keep current image';
                            imageHelpText.parentElement.classList.remove('text-info');
                            imageHelpText.parentElement.classList.add('text-warning');
                        }
                    }
                });
            }

            // File input change handler
            if (imageFile) {
                imageFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    
                    if (file) {
                        // Validate file type
                        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                        if (!allowedTypes.includes(file.type)) {
                            showImageError('Please select a valid image file (JPG, PNG, or GIF)');
                            return;
                        }
                        
                        // Validate file size (5MB max)
                        const maxSize = 5 * 1024 * 1024; // 5MB in bytes
                        if (file.size > maxSize) {
                            showImageError('Image file size must be less than 5MB');
                            return;
                        }
                        
                        // Create file reader for preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            showImagePreview(e.target.result, file.name);
                        };
                        reader.readAsDataURL(file);
                        
                        // Clear any previous errors
                        clearImageError();
                    }
                });

                // Upload button click handler
                uploadImageBtn.addEventListener('click', function() {
                    imageFile.click();
                });

                // Remove new image button handler
                removeImageBtn.addEventListener('click', function() {
                    clearImagePreview();
                });

                // Enhanced drag and drop functionality
                const imageContainer = document.getElementById('imagePreviewContainer');
                if (imageContainer) {
                    imageContainer.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.style.borderColor = '#0dcaf0';
                        this.style.backgroundColor = 'rgba(13, 202, 240, 0.1)';
                        this.style.transform = 'scale(1.02)';
                    });

                    imageContainer.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.style.borderColor = '';
                        this.style.backgroundColor = '';
                        this.style.transform = '';
                    });

                    imageContainer.addEventListener('drop', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.style.borderColor = '';
                        this.style.backgroundColor = '';
                        this.style.transform = '';

                        const files = e.dataTransfer.files;
                        if (files.length > 0) {
                            imageFile.files = files;
                            imageFile.dispatchEvent(new Event('change'));
                        }
                    });

                    // Click to upload functionality
                    imageContainer.addEventListener('click', function() {
                        if (imagePreview.classList.contains('d-none')) {
                            imageFile.click();
                        }
                    });
                }
            }

            function showImagePreview(src, fileName) {
                imagePreview.src = src;
                imagePreview.classList.remove('d-none');
                imagePreviewPlaceholder.classList.add('d-none');
                removeImageBtn.classList.remove('d-none');
                
                // Dim current image when showing new preview
                if (currentImage) {
                    currentImage.style.opacity = '0.4';
                    currentImage.style.filter = 'grayscale(50%)';
                }
                
                // Update help text
                imageHelpText.innerHTML = `<i class="bi bi-check-circle me-1 text-success"></i>New image selected: <strong>${fileName}</strong> - This will replace the current image`;
                imageHelpText.parentElement.classList.remove('text-info', 'text-warning');
                imageHelpText.parentElement.classList.add('text-success');
                
                // Set border styling
                imageFile.style.borderColor = '#0dcaf0';
                imageFile.style.backgroundColor = 'rgba(13, 202, 240, 0.05)';
            }

            function clearImagePreview() {
                imagePreview.src = '#';
                imagePreview.classList.add('d-none');
                imagePreviewPlaceholder.classList.remove('d-none');
                removeImageBtn.classList.add('d-none');
                imageFile.value = '';
                
                // Restore current image appearance if it exists
                if (currentImage) {
                    currentImage.style.opacity = '1';
                    currentImage.style.filter = 'none';
                }
                
                // Reset help text
                const hasCurrentImage = currentImage && !currentImage.classList.contains('d-none');
                imageHelpText.innerHTML = hasCurrentImage 
                    ? '<i class="bi bi-info-circle me-1"></i>Select a new product image (JPG, PNG, GIF - Max 5MB)'
                    : '<i class="bi bi-info-circle me-1"></i>Select a product image (JPG, PNG, GIF - Max 5MB)';
                imageHelpText.parentElement.classList.remove('text-success', 'text-danger', 'text-warning');
                imageHelpText.parentElement.classList.add('text-info');
                
                // Reset styling
                imageFile.style.borderColor = '#0dcaf0';
                imageFile.style.backgroundColor = '';
                
                // Show action buttons again if current image exists
                if (hasCurrentImage) {
                    imageUploadSection.classList.add('d-none');
                    if (showUploadBtn) {
                        showUploadBtn.classList.remove('d-none');
                    }
                    if (removeCurrentImageBtn) {
                        removeCurrentImageBtn.classList.remove('d-none');
                    }
                }
            }

            function showImageError(message) {
                imageHelpText.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${message}`;
                imageHelpText.parentElement.classList.remove('text-info', 'text-success', 'text-warning');
                imageHelpText.parentElement.classList.add('text-danger');
                
                imageFile.style.borderColor = '#CA1929';
                imageFile.style.backgroundColor = 'rgba(202, 25, 41, 0.05)';
                
                // Clear the file input
                imageFile.value = '';
            }

            function clearImageError() {
                imageHelpText.parentElement.classList.remove('text-danger');
                imageHelpText.parentElement.classList.add('text-info');
                
                imageFile.style.borderColor = '#0dcaf0';
                imageFile.style.backgroundColor = '';
            }

            // Enhanced category selection styling and validation
            const categorySelect = document.querySelector('select[name="Product.CategoryId"]');
            const categoryHelpText = document.getElementById('categoryHelpText');
            if (categorySelect && categoryHelpText) {
                // Initialize current category display
                const currentCategoryId = '@Model.Product.CategoryId';
                if (currentCategoryId && categorySelect.value) {
                    const selectedText = categorySelect.options[categorySelect.selectedIndex].text;
                    if (selectedText !== '-- Select Category --') {
                        categoryHelpText.innerHTML = `<i class="bi bi-check-circle me-1 text-success"></i>Current category: <strong>${selectedText}</strong>`;
                    }
                }

                categorySelect.addEventListener('change', function() {
                    if (this.value) {
                        this.style.borderColor = '#4b7147';
                        this.style.backgroundColor = 'rgba(75, 113, 71, 0.05)';
                        
                        // Show selected category feedback
                        const selectedText = this.options[this.selectedIndex].text;
                        if (selectedText !== '-- Select Category --') {
                            categoryHelpText.innerHTML = `<i class="bi bi-check-circle me-1 text-success"></i>Selected category: <strong>${selectedText}</strong>`;
                        }
                    } else {
                        this.style.borderColor = '#4b7147';
                        this.style.backgroundColor = '';
                        
                        // Reset help text
                        categoryHelpText.innerHTML = '<i class="bi bi-info-circle me-1"></i>Update the category this product belongs to';
                    }
                });

                categorySelect.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 0.25rem rgba(75, 113, 71, 0.25)';
                });
                
                categorySelect.addEventListener('blur', function() {
                    this.style.boxShadow = '';
                });
            }

            // Real-time character counter for title field
            const titleInput = document.querySelector('input[name="Product.Title"]');
            const titleHelpText = document.getElementById('titleHelpText');
            if (titleInput && titleHelpText) {
                const maxLength = titleInput.getAttribute('maxlength');
                
                function updateTitleCounter() {
                    const currentLength = titleInput.value.length;
                    const remaining = maxLength - currentLength;
                    
                    titleHelpText.innerHTML = `Update the product title (${remaining} characters remaining)`;
                    
                    if (remaining < 20) {
                        titleHelpText.parentElement.classList.remove('text-success');
                        titleHelpText.parentElement.classList.add('text-warning');
                        titleInput.style.borderColor = '#BD7418';
                    } else if (remaining < 10) {
                        titleHelpText.parentElement.classList.remove('text-success', 'text-warning');
                        titleHelpText.parentElement.classList.add('text-danger');
                        titleInput.style.borderColor = '#CA1929';
                    } else {
                        titleHelpText.parentElement.classList.remove('text-warning', 'text-danger');
                        titleHelpText.parentElement.classList.add('text-success');
                        titleInput.style.borderColor = '#4b7147';
                    }
                }
                
                titleInput.addEventListener('input', updateTitleCounter);
                titleInput.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 0.25rem rgba(75, 113, 71, 0.25)';
                });
                titleInput.addEventListener('blur', function() {
                    this.style.boxShadow = '';
                });
                updateTitleCounter(); // Initialize counter
            }

            // Real-time character counter for description field
            const descriptionInput = document.querySelector('textarea[name="Product.Description"]');
            const descriptionHelpText = document.getElementById('descriptionHelpText');
            if (descriptionInput && descriptionHelpText) {
                const maxLength = descriptionInput.getAttribute('maxlength');
                
                function updateDescriptionCounter() {
                    const currentLength = descriptionInput.value.length;
                    const remaining = maxLength - currentLength;
                    
                    descriptionHelpText.innerHTML = `Update the product description (${remaining} characters remaining)`;
                    
                    if (remaining < 50) {
                        descriptionHelpText.parentElement.classList.remove('text-success');
                        descriptionHelpText.parentElement.classList.add('text-warning');
                        descriptionInput.style.borderColor = '#BD7418';
                    } else if (remaining < 20) {
                        descriptionHelpText.parentElement.classList.remove('text-success', 'text-warning');
                        descriptionHelpText.parentElement.classList.add('text-danger');
                        descriptionInput.style.borderColor = '#CA1929';
                    } else {
                        descriptionHelpText.parentElement.classList.remove('text-warning', 'text-danger');
                        descriptionHelpText.parentElement.classList.add('text-success');
                        descriptionInput.style.borderColor = '#4b7147';
                    }
                }
                
                descriptionInput.addEventListener('input', updateDescriptionCounter);
                descriptionInput.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 0.25rem rgba(75, 113, 71, 0.25)';
                });
                descriptionInput.addEventListener('blur', function() {
                    this.style.boxShadow = '';
                });
                updateDescriptionCounter(); // Initialize counter
            }

            // Pricing validation and auto-calculation
            const priceInputs = document.querySelectorAll('input[type="number"]');
            priceInputs.forEach(function(input) {
                input.addEventListener('input', function() {
                    const value = parseFloat(this.value);
                    
                    if (value <= 0 || value > 10000) {
                        this.style.borderColor = '#CA1929';
                        this.style.backgroundColor = 'rgba(202, 25, 41, 0.05)';
                    } else {
                        this.style.borderColor = '#BD7418';
                        this.style.backgroundColor = 'rgba(189, 116, 24, 0.05)';
                    }
                });

                input.addEventListener('focus', function() {
                    this.style.boxShadow = '0 0 0 0.25rem rgba(189, 116, 24, 0.25)';
                });
                
                input.addEventListener('blur', function() {
                    this.style.boxShadow = '';
                    
                    // Validate pricing logic
                    validatePricingTiers();
                });
            });

            // Validate pricing tiers logic
            function validatePricingTiers() {
                const listPrice = parseFloat(document.querySelector('input[name="Product.ListPrice"]')?.value || 0);
                const price = parseFloat(document.querySelector('input[name="Product.Price"]')?.value || 0);
                const price50 = parseFloat(document.querySelector('input[name="Product.Price50"]')?.value || 0);
                const price100 = parseFloat(document.querySelector('input[name="Product.Price100"]')?.value || 0);
                
                // Check if prices decrease with quantity
                if (price > 0 && price50 > 0 && price50 > price) {
                    showPriceWarning('Product.Price50', 'Bulk price (50+) should be lower than regular price');
                }
                
                if (price50 > 0 && price100 > 0 && price100 > price50) {
                    showPriceWarning('Product.Price100', 'Bulk price (100+) should be lower than 50+ price');
                }
                
                if (listPrice > 0 && price > 0 && price > listPrice) {
                    showPriceWarning('Product.Price', 'Regular price should not exceed list price');
                }
            }

            function showPriceWarning(fieldName, message) {
                const field = document.querySelector(`input[name="${fieldName}"]`);
                if (field) {
                    field.style.borderColor = '#BD7418';
                    field.style.backgroundColor = 'rgba(189, 116, 24, 0.1)';
                    
                    // Add temporary tooltip or message
                    const existingWarning = field.parentElement.querySelector('.price-warning');
                    if (existingWarning) existingWarning.remove();
                    
                    const warning = document.createElement('small');
                    warning.className = 'price-warning text-warning d-block mt-1';
                    warning.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${message}`;
                    field.parentElement.insertAdjacentElement('afterend', warning);
                    
                    setTimeout(() => {
                        warning?.remove();
                        if (field.checkValidity()) {
                            field.style.borderColor = '#BD7418';
                            field.style.backgroundColor = '';
                        }
                    }, 3000);
                }
            }

            // Confirmation for delete action with themed modal
            const deleteLinks = document.querySelectorAll('a[href*="Delete"]');
            deleteLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    const productTitle = '@Model.Product.Title';
                    
                    const message = productTitle 
                        ? `⚠️ Delete "${productTitle}"?\n\nThis action cannot be undone and will remove the product from your catalog.`
                        : '⚠️ Are you sure you want to delete this product?\n\nThis action cannot be undone.';
                    
                    if (!confirm(message)) {
                        e.preventDefault();
                    }
                });
            });

            // Touch-friendly form interactions for mobile
            if ('ontouchstart' in window) {
                const formControls = document.querySelectorAll('.form-control, .form-select');
                formControls.forEach(function(control) {
                    control.addEventListener('focus', function() {
                        // Scroll to input on mobile when focused
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
            }

            // Enhanced change tracking with visual feedback
            let changesMade = false;
            const inputs = document.querySelectorAll('input, textarea, select');
            const originalValues = {};
            
            inputs.forEach(function(input) {
                originalValues[input.name] = input.value;
                
                input.addEventListener('input', function() {
                    changesMade = (this.value !== originalValues[this.name]);
                    
                    // Add visual indicator for changes with theme colors
                    if (changesMade && this.value !== originalValues[this.name]) {
                        if (this.type === 'number') {
                            this.style.borderColor = '#BD7418';
                        } else if (this.type === 'file') {
                            this.style.borderColor = '#0dcaf0';
                        } else {
                            this.style.borderColor = '#4b7147';
                        }
                        this.style.borderWidth = '2px';
                        if (this.type !== 'file') {
                            this.style.backgroundColor = 'rgba(75, 113, 71, 0.05)';
                        }
                    } else {
                        if (this.type !== 'file') {
                            this.style.backgroundColor = '';
                        }
                    }
                });
            });

            // Warn user about unsaved changes when leaving
            window.addEventListener('beforeunload', function(e) {
                if (changesMade) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Add success animation on valid input
            inputs.forEach(function(input) {
                input.addEventListener('blur', function() {
                    if (this.checkValidity() && this.value.length > 0) {
                        if (this.type === 'number') {
                            this.style.borderColor = '#BD7418';
                        } else if (this.type === 'file') {
                            this.style.borderColor = '#0dcaf0';
                        } else {
                            this.style.borderColor = '#4b7147';
                        }
                        setTimeout(() => {
                            if (this.value === originalValues[this.name]) {
                                if (this.type === 'number') {
                                    this.style.borderColor = '#BD7418';
                                } else if (this.type === 'file') {
                                    this.style.borderColor = '#0dcaf0';
                                } else {
                                    this.style.borderColor = '#4b7147';
                                }
                            }
                        }, 1000);
                    }
                });
            });
        });
    </script>
}

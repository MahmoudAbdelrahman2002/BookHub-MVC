@using BulkyWeb.Areas.Admin.Models
@model RoleManagementViewModel
@{
    ViewData["Title"] = "Role Management - Admin";
}

<!-- Role Management Hero Section -->
<section class="role-management-hero py-4 py-md-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 50%, #dee2e6 100%); position: relative; overflow: hidden;">
    <div class="container position-relative">
        <div class="row align-items-center">
            <div class="col-12">
                <!-- Breadcrumb Navigation -->
                <nav aria-label="breadcrumb" class="mb-4">
                    <ol class="breadcrumb bg-white p-3 rounded-3 shadow-sm border-0">
                        <li class="breadcrumb-item">
                            <a asp-area="" asp-controller="Home" asp-action="Index" class="text-decoration-none text-primary">
                                <i class="bi bi-house me-1"></i>Home
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-area="Admin" asp-controller="User" asp-action="Index" class="text-decoration-none text-primary">
                                <i class="bi bi-people me-1"></i>User Management
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-warning fw-medium" aria-current="page">
                            Role Management
                        </li>
                    </ol>
                </nav>

                <!-- Page Header -->
                <div class="row">
                    <div class="col-12 col-lg-8">
                        <h1 class="display-5 fw-bold text-warning mb-3" style="font-family: 'Georgia', serif;">
                            <i class="bi bi-person-gear me-3"></i>Role Management
                        </h1>
                        <p class="lead text-muted mb-4">
                            Update user role and company assignment for <strong>@Model.ApplicationUser.Name</strong>
                        </p>
                    </div>
                    <div class="col-12 col-lg-4 text-lg-end">
                        <div class="admin-badge-container">
                            <span class="badge bg-danger fs-6 px-3 py-2 rounded-pill shadow-sm">
                                <i class="bi bi-shield-exclamation me-1"></i>
                                Admin Only
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Role Management Section -->
<section class="role-management-form py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="row g-4 g-lg-5">
                    <!-- Role Management Form -->
                    <div class="col-12 col-lg-8">
                        <div class="card border-0 shadow-lg" style="border-radius: 15px;">
                            <!-- Card Header -->
                            <div class="card-header bg-warning text-dark py-4" style="border-radius: 15px 15px 0 0; background: linear-gradient(135deg, #ffc107, #e0a800) !important;">
                                <h2 class="card-title mb-0 fw-bold">
                                    <i class="bi bi-person-badge me-2"></i>Update User Role
                                </h2>
                                <p class="mb-0 opacity-90">Modify role and company assignment</p>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body p-4 p-md-5">
                                <!-- Current User Information -->
                                <div class="user-info-section mb-5">
                                    <div class="card bg-light border-0" style="border-radius: 12px;">
                                        <div class="card-body p-4">
                                            <h5 class="text-primary fw-bold mb-3">
                                                <i class="bi bi-person-circle me-2"></i>Current User Information
                                            </h5>
                                            <div class="row g-3">
                                                <div class="col-12 col-md-6">
                                                    <div class="info-item d-flex align-items-center">
                                                        <div class="user-avatar me-3">
                                                            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                                                 style="width: 50px; height: 50px; font-weight: bold; font-size: 1.2rem;">
                                                                @Model.ApplicationUser.Name.First()
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-1 fw-bold">@Model.ApplicationUser.Name</h6>
                                                            <small class="text-muted">@Model.ApplicationUser.Email</small>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <div class="info-item">
                                                        <small class="text-muted d-block">Current Role</small>
                                                        <span class="badge bg-info text-dark fs-6 mt-1">
                                                            <i class="bi bi-person-badge me-1"></i>
                                                            @ViewBag.CurrentRole
                                                        </span>
                                                    </div>
                                                </div>
                                                @if (Model.ApplicationUser.Company != null)
                                                {
                                                    <div class="col-12">
                                                        <div class="info-item">
                                                            <small class="text-muted d-block">Current Company</small>
                                                            <span class="badge bg-success fs-6 mt-1">
                                                                <i class="bi bi-building me-1"></i>
                                                                @Model.ApplicationUser.Company.Name
                                                            </span>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Role Management Form -->
                                <form asp-action="RoleManagement" method="post" id="roleManagementForm" class="needs-validation" novalidate>
                                    <input asp-for="ApplicationUser.Id" hidden />
                                    
                                    <!-- Role Selection Section -->
                                    <div class="form-section mb-5">
                                        <h4 class="section-title mb-4">
                                            <i class="bi bi-gear-fill me-2 text-warning"></i>Role Assignment
                                            <div class="section-divider"></div>
                                        </h4>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <select asp-for="Role" asp-items="Model.RoleList" 
                                                            class="form-select form-select-lg border-warning" 
                                                            required style="border-width: 2px;" id="roleSelect">
                                                        <option value="">-- Select New Role --</option>
                                                    </select>
                                                    <label asp-for="Role" class="text-warning fw-medium">
                                                        <i class="bi bi-person-badge me-1"></i>User Role
                                                    </label>
                                                    <span asp-validation-for="Role" class="text-danger small mt-1 d-block"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <!-- Company Selection (shown when Company role is selected) -->
                                                <div class="form-floating" id="companySelectionDiv" style="@(ViewBag.CurrentRole == "Company" ? "" : "display: none;")">
                                                    <select asp-for="CompanyId" asp-items="Model.CompanyList" 
                                                            class="form-select form-select-lg border-info" 
                                                            style="border-width: 2px;" id="companySelect">
                                                        <option value="">-- Select Company --</option>
                                                    </select>
                                                    <label asp-for="CompanyId" class="text-info fw-medium">
                                                        <i class="bi bi-building me-1"></i>Company Assignment
                                                    </label>
                                                    <span asp-validation-for="CompanyId" class="text-danger small mt-1 d-block"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Warning Section -->
                                    <div class="alert alert-warning border-0 shadow-sm mb-4" style="border-radius: 12px; border-left: 5px solid #ffc107 !important;">
                                        <div class="d-flex align-items-start">
                                            <div class="flex-shrink-0 me-3">
                                                <i class="bi bi-exclamation-triangle-fill text-warning fs-4"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="alert-heading fw-bold mb-2">
                                                    <i class="bi bi-shield-exclamation me-1"></i>Important: Role Change Impact
                                                </h6>
                                                <ul class="mb-0">
                                                    <li>Changing roles will immediately affect user permissions</li>
                                                    <li>Company users must be assigned to a valid company</li>
                                                    <li>Role changes are logged for security audit</li>
                                                    <li>Users may need to log out and back in for changes to take effect</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                                                <a asp-action="Index" class="btn btn-secondary btn-lg px-4 order-2 order-sm-1" style="border-radius: 12px;">
                                                    <i class="bi bi-arrow-left me-2"></i>Back to Users
                                                </a>
                                                <button type="submit" class="btn btn-warning btn-lg px-4 fw-bold shadow-lg order-1 order-sm-2" 
                                                        style="border-radius: 12px;" id="submitBtn">
                                                    <i class="bi bi-person-gear me-2"></i>
                                                    <span id="submitText">Update Role</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Information Panel -->
                    <div class="col-12 col-lg-4">
                        <!-- Role Information -->
                        <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                            <div class="card-header bg-light border-0 py-3">
                                <h5 class="card-title mb-0 text-warning fw-bold">
                                    <i class="bi bi-info-circle me-2"></i>Role Permissions
                                </h5>
                            </div>
                            <div class="card-body p-4">
                                <div class="role-permissions">
                                    <div class="permission-item mb-3 p-3 rounded" style="background: rgba(13, 110, 253, 0.05); border-left: 4px solid #0d6efd;">
                                        <h6 class="fw-bold text-primary mb-1">
                                            <i class="bi bi-person me-1"></i>Customer
                                        </h6>
                                        <ul class="small text-muted mb-0">
                                            <li>Browse product catalog</li>
                                            <li>Place orders</li>
                                            <li>Manage profile</li>
                                        </ul>
                                    </div>
                                    <div class="permission-item mb-3 p-3 rounded" style="background: rgba(25, 135, 84, 0.05); border-left: 4px solid #198754;">
                                        <h6 class="fw-bold text-success mb-1">
                                            <i class="bi bi-building me-1"></i>Company
                                        </h6>
                                        <ul class="small text-muted mb-0">
                                            <li>All customer permissions</li>
                                            <li>Bulk ordering</li>
                                            <li>Company-specific pricing</li>
                                        </ul>
                                    </div>
                                    <div class="permission-item mb-3 p-3 rounded" style="background: rgba(255, 193, 7, 0.05); border-left: 4px solid #ffc107;">
                                        <h6 class="fw-bold text-warning mb-1">
                                            <i class="bi bi-briefcase me-1"></i>Employee
                                        </h6>
                                        <ul class="small text-muted mb-0">
                                            <li>All customer permissions</li>
                                            <li>Order management</li>
                                            <li>Limited admin access</li>
                                        </ul>
                                    </div>
                                    <div class="permission-item p-3 rounded" style="background: rgba(220, 53, 69, 0.05); border-left: 4px solid #dc3545;">
                                        <h6 class="fw-bold text-danger mb-1">
                                            <i class="bi bi-shield-check me-1"></i>Admin
                                        </h6>
                                        <ul class="small text-muted mb-0">
                                            <li>Full system access</li>
                                            <li>User management</li>
                                            <li>Content management</li>
                                            <li>System configuration</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Notice -->
                        <div class="card border-0 bg-light" style="border-radius: 12px;">
                            <div class="card-body p-4">
                                <h6 class="text-danger fw-bold mb-3">
                                    <i class="bi bi-shield-exclamation me-2"></i>Security Notice
                                </h6>
                                <ul class="list-unstyled small">
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        All role changes are logged with timestamp and admin user
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        User will retain access to previous orders and data
                                    </li>
                                    <li class="mb-2">
                                        <i class="bi bi-check-circle text-success me-2"></i>
                                        Company assignment is validated before saving
                                    </li>
                                    <li class="mb-0">
                                        <i class="bi bi-shield-check text-warning me-2"></i>
                                        Changes take effect immediately upon saving
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
            initializeRoleSelection();
            initializeValidation();
        });

        function initializeForm() {
            const form = document.getElementById('roleManagementForm');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');

            if (form && submitBtn) {
                form.addEventListener('submit', function() {
                    submitBtn.disabled = true;
                    submitText.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Updating Role...';
                    submitBtn.classList.add('btn-secondary');
                    submitBtn.classList.remove('btn-warning');
                });
            }
        }

        function initializeRoleSelection() {
            const roleSelect = document.getElementById('roleSelect');
            const companySelectionDiv = document.getElementById('companySelectionDiv');
            const companySelect = document.getElementById('companySelect');
            const permissionItems = document.querySelectorAll('.permission-item');

            if (roleSelect) {
                roleSelect.addEventListener('change', function() {
                    const selectedRole = this.value;
                    
                    // Reset all permission items
                    permissionItems.forEach(item => {
                        item.style.transform = 'scale(1)';
                        item.style.opacity = '0.7';
                        item.style.transition = 'all 0.3s ease';
                    });

                    // Show/hide company selection based on role
                    if (selectedRole === 'Company') {
                        companySelectionDiv.style.display = 'block';
                        companySelect.setAttribute('required', 'required');
                        companySelectionDiv.style.animation = 'fadeInRight 0.5s ease';
                    } else {
                        companySelectionDiv.style.display = 'none';
                        companySelect.removeAttribute('required');
                        companySelect.value = '';
                    }

                    // Highlight selected role permissions
                    if (selectedRole) {
                        const roleIndex = {
                            'Customer': 0,
                            'Company': 1,
                            'Employee': 2,
                            'Admin': 3
                        };

                        const selectedIndex = roleIndex[selectedRole];
                        if (selectedIndex !== undefined && permissionItems[selectedIndex]) {
                            permissionItems[selectedIndex].style.transform = 'scale(1.05)';
                            permissionItems[selectedIndex].style.opacity = '1';
                            permissionItems[selectedIndex].style.boxShadow = '0 8px 25px rgba(0,0,0,0.1)';
                        }
                    }
                });

                // Trigger change event on load to set initial state
                roleSelect.dispatchEvent(new Event('change'));
            }
        }

        function initializeValidation() {
            const form = document.querySelector('.needs-validation');
            
            if (form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        // Scroll to first invalid field
                        const firstInvalid = form.querySelector(':invalid');
                        if (firstInvalid) {
                            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            firstInvalid.focus();
                        }
                    }
                    
                    form.classList.add('was-validated');
                }, false);
            }

            // Real-time validation feedback
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                select.addEventListener('change', function() {
                    if (this.checkValidity()) {
                        this.style.borderColor = '#198754';
                    } else {
                        this.style.borderColor = '#dc3545';
                    }
                });
            });
        }

        // Animation keyframes
        const style = document.createElement('style');
        style.textContent = `
            @@keyframes fadeInRight {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }
        `;
        document.head.appendChild(style);
    </script>
}

<style>
    /* Role Management Form Styling */
    .role-management-hero {
        min-height: 40vh;
    }

    .user-info-section .user-avatar .rounded-circle {
        transition: all 0.3s ease;
    }

    .user-info-section .user-avatar .rounded-circle:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .form-section {
        position: relative;
    }

    .section-title {
        color: #495057;
        font-family: 'Georgia', serif;
        position: relative;
        padding-bottom: 10px;
    }

    .section-divider {
        height: 3px;
        background: linear-gradient(to right, #ffc107, #e0a800, #d39e00);
        border-radius: 3px;
        margin-top: 8px;
        width: 60px;
    }

    .permission-item {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .permission-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .form-floating > label {
        font-family: 'Georgia', serif;
        font-weight: 500;
    }

    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
        border-color: #ffc107;
    }

    /* Admin badge animation */
    .admin-badge-container .badge {
        animation: gentle-pulse 3s ease-in-out infinite;
    }

    @@keyframes gentle-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    /* Button styling */
    .btn {
        transition: all 0.3s ease;
        border-width: 2px;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.2);
    }

    /* Info items styling */
    .info-item {
        padding: 0.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .info-item:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    /* Custom validation styling */
    .was-validated .form-select:valid {
        border-color: #198754;
        background-image: none;
    }

    .was-validated .form-select:invalid {
        border-color: #dc3545;
        background-image: none;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .role-management-hero {
            min-height: 30vh;
            padding: 2rem 0 !important;
        }
        
        .display-5 {
            font-size: 2rem !important;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }

        .user-avatar .rounded-circle {
            width: 40px !important;
            height: 40px !important;
            font-size: 1rem !important;
        }
    }

    @@media (max-width: 576px) {
        .display-5 {
            font-size: 1.75rem !important;
        }
        
        .btn-lg {
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
        }

        .permission-item {
            font-size: 0.9rem;
        }
    }

    /* Loading state styling */
    .btn:disabled {
        opacity: 0.8;
        cursor: not-allowed;
    }

    /* Badge styling */
    .badge {
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
    }
</style>